# Invidiually-Unique Pokémon Colors (+ Improved Shiny Colors) for Pokémon HeartGold

[(Example video)](https://imgur.com/a/Xb3QwaE)

This HeartGold hack aims to make it so each individual Pokémon has a slight color variation based on its personality value. This is inspired by a [similar feature](https://guidesmedia.ign.com/guides/9846/images/pikacolors.jpg) from the Pokémon Stadium games that does just this but based on the Pokémon's nickname. The ROM hack [Pokémon Polished Crystal](https://github.com/Rangi42/polishedcrystal) implements a very similar feature based on IV values. This implementation performs a hue shift on the Pokémon's palette on load.

If you would like to use this in your own hacks, please feel free to do so!


## Improved Shiny Colors

Some Pokémon have shiny colors that are very close to their non-shiny colors, or at least close enough that the simple hue shift performed by this hack may make a normal Pokémon look shiny. To remedy this, many Pokémon have been given revamped shiny colors. In additon, the opportunity has been taken to revamp Pokémon that seem to have obviously "bad" shiny palettes even if there's no ambiguity issue.

List of changed Pokémon (so far):

![Pichu](ShinyChanges/pichu_shiny.png) ![Pikachu](ShinyChanges/pikachu_shiny.png) ![Raichu](ShinyChanges/raichu_shiny.png)

**Pichu, Pikachu, Raichu** - Tried to make visually distinct instead of the slight orange tint. A bit of a gradient from pale yellow to pale orange throughout the evolutionary line.

![Nidoqueen](ShinyChanges/nidoqueen_shiny.png)

**Nidoqueen** - Colors made to look like Nidoking, which matches the pattern set by all other members of the Nidoran lines.

![Meowth](ShinyChanges/meowth_shiny.png) ![Persian](ShinyChanges/persian_shiny.png)

**Meowth, Persian** - Mint green to complement vanilla shiny Meowth's pink, and with a silver coin and ears, respectively. *(The image data of Meowth's sprite has also been tweaked.)*

![Abra](ShinyChanges/abra_shiny.png) ![Kadabra](ShinyChanges/kadabra_shiny.png)

**Abra, Kadabra** - More pink instead of brown to match, and create a gradient towards, shiny Alakazam.

![Seel](ShinyChanges/seel_shiny.png) ![Dewgong](ShinyChanges/dewgong_shiny.png)

**Seel, Dewgong** - Made to look more visibly gold. The color used in the highlight in Seel's eyes (added in HG/SS) has been fixed for the shiny palette (Game Freak forgot to change the color, so it just stayed the default "unused magenta" color).

![Haunter](ShinyChanges/haunter_shiny.png) ![Gengar](ShinyChanges/gengar_shiny.png)

![Normal Gengar](ShinyChanges/gengar_normal.png)

**Haunter, Gengar** - Tried to make a sensible gradient from Gastly to Mega Gengar (purple -> white with blue highlights). Normal Gengar has been also modified to be like its [anime palette](https://static.wikia.nocookie.net/pokemon/images/8/8a/Morty_Gengar.png).

![Scyther](ShinyChanges/scyther_shiny.png)

**Scyther** - Made to be red-orange, which makes shiny Scyther and Scizor effectively be a loose swap of their normal colors.

![Elekid](ShinyChanges/elekid_shiny.png) ![Electabuzz](ShinyChanges/electabuzz_shiny.png) ![Electivire](ShinyChanges/electivire_shiny.png)

**Elekid, Electabuzz, Electivire** - Light blue, with Elekid being slightly more Cyan. Electivire has gold tips.

![Munchlax](ShinyChanges/munchlax_shiny.png) ![Snorlax](ShinyChanges/snorlax_shiny.png)

**Munchlax, Snorlax** - Like a brown bear.

![Articuno](ShinyChanges/articuno_shiny.png)

**Articuno** - Lavender.

![Zapdos](ShinyChanges/zapdos_shiny.png)

**Zapdos** - Brown.

![Sunkern](ShinyChanges/sunkern_shiny.png) ![Sunflora](ShinyChanges/sunflora_shiny.png)

**Sunkern, Sunflora** - Purple and a more blueish green, resembling a [purple sunflower](https://m.media-amazon.com/images/I/71rqiFQLLiL._AC_SL1203_.jpg).

![Espeon](ShinyChanges/espeon_shiny.png)

**Espeon** - Less overly saturated.

![Leafeon](ShinyChanges/leafeon_shiny.png)

**Leafeon** - Fall colors, inspired by [various](https://aminoapps.com/c/shiny-pokemon-amino/page/blog/do-you-wish-shiny-leafeon-and-shiny-glaceon-was-batter/7eJV_e2nUPuEW5ZJBD4wELq7qDGjnMQboM) [posts](https://www.deviantart.com/littlepie95/art/Improved-Shiny-Leafeon-806020174) suggesting the idea.

![Magcargo](ShinyChanges/magcargo_shiny.png)

**Magcargo** - Lava part matches shiny Slugma.

![Mantyke](ShinyChanges/mantyke_shiny.png) ![Mantine](ShinyChanges/mantine_shiny.png)

**Mantyke, Mantine** - Green and aqua-ish scheme, based on [this](https://www.deviantart.com/rayquazaflygon/art/Alt-Shiny-Mantine-711360951) post by RayquazaFlygon.

![Phanphy](ShinyChanges/phanphy_shiny.png)

**Phanphy** - Inverted from its normal palette.

![Smoochum](ShinyChanges/smoochum_shiny.png)

**Smoochum** - Lavender and light-pink body, and platinum blonde hair to match shiny Jynx.

![Magby](ShinyChanges/magby_shiny.png)

**Magby** - Red-pink and pink to match Magmar and Magmortar's shiny colors.

![Happiny](ShinyChanges/happiny_shiny.png) ![Blissey](ShinyChanges/blissey_shiny.png)

**Happiny, Blissey** - Green and light-gold-tan to match shiny Chansey. *(The image data of Blissey's sprite has also been tweaked.)*

![Combusken](ShinyChanges/combusken_shiny.png)

**Combusken** - Changed to match the color change made in Sword/Shield.

![Loudred](ShinyChanges/loudred_shiny.png) ![Exploud](ShinyChanges/exploud_shiny.png)

**Loudred, Exploud** - Lime green details instead of yellow to match shiny Whismur.

![Plusle](ShinyChanges/plusle_shiny.png)

**Plusle** - Hot pink/magenta.

![Regice](ShinyChanges/regice_shiny.png)

**Regice** - A deep dark blue, inspired by [this post](https://www.reddit.com/r/MandJTV/comments/ibqj33/shiny_regice_redesign_its_not_much_but_its_better/) by [/u/SmallBigBrainBoi](https://www.reddit.com/user/SmallBigBrainBoi).

![Piplup](ShinyChanges/piplup_shiny.png) ![Prinplup](ShinyChanges/prinplup_shiny.png) ![Empoleon](ShinyChanges/empoleon_shiny.png)

**Piplup, Prinplup, Empoleon** - Based off of [this post](https://imgur.com/t/shinypokemon/LMnl0Jx) from cjgart2000. Intended to give the "emporer penguin" look.

![Gabite](ShinyChanges/gabite_shiny.png) ![Garchomp](ShinyChanges/garchomp_shiny.png)

**Gabite, Garchomp** - Tried to make them consistent with shiny Gible (deeper blue, yellow/orange belly).

![Snover](ShinyChanges/snover_shiny.png) ![Abomasnow](ShinyChanges/abomasnow_shiny.png)

**Snover, Abomasnow** - Extremeties made a deeper blue to make the worst case between normal and shiny less ambiguous.

![Dusknoir](ShinyChanges/dusknoir_shiny.png)

**Dusknoir** - Red to match shiny Duskull and Dusclops.

![Froslass](ShinyChanges/froslass_shiny.png)

**Froslass** - A rose/sakura body with a violet belt/bow.

![Phione](ShinyChanges/phione_shiny.png) ![Manaphy](ShinyChanges/manaphy_shiny.png)

**Phione, Manaphy** - Purplish-blue body, cyan eyelashes for Manaphy, purple gem. Based on [this post](https://www.deviantart.com/epicgordoman/art/Shiny-Manaphy-747110225) by EpicGordoMan.


## Building

1. Install [devkitARM](https://devkitpro.org/wiki/Getting_Started).
2. Install a [D compiler](https://dlang.org/download.html).
3. Download NSMB Editor. Because the latest version (as of 379) is broken with regard to decompressing overlays, I recommend [this custom version](https://nsmbhd.net/post/53582/) from MeroMero. An [older version](https://nsmbhd.net/download/353/) may work also. For Windows users, [CrystalTile2](https://www.romhacking.net/utilities/818/) may also work.
4. Download [PokeEditor](https://github.com/turtleisaac/PokEditor/releases), extract it into the root folder of this repo, and rename folder that got extracted to `PokEditor`.
5. Open up your ROM in NSMBe (ignoring the error that comes up on load when using MeroMero's build).
6. Under "Tools/Options", select "Decompress ARM9 binary".
7. Under "ROM File Browser", select `arm9.bin`, click "Extract", and save as `arm9_hg_vanilla.bin` in the root folder of this repo.
8. In the `overlay9` folder, select `overlay9_1.bin`, click "Decompress overlay", click "Extract", and save as `overlay1_hg_vanilla.bin`. Do similarly with overlays 7, 12, and 14 (`overlay1_hg_vanilla.bin`, `overlay12_hg_vanilla.bin`, `overlay14_hg_vanilla.bin`).
9. In the `root/a/0/2` folder, extract file `8` as `custom_overlay_hg_vanilla.narc`.
10. On the command line, run `./build.sh`.
11. In NSMBe, reinsert `arm9_hg_patched.bin`, `overlay1_hg_patched.bin`, `overlay7_hg_patched.bin`, `overlay12_hg_patched.bin`, and `overlay14_hg_patched.bin` back into `arm9.bin`, `overlay9_7.bin`, `overlay9_12.bin`, and `overlay9_14.bin`, respectively. For `arm9.bin`, you may need to hit "Decompress ARM9 Binary" to correctly insert it (not sure).
12. Extract `root/a/0/0/4` as `hg_pokegra.narc`.
13. For each image in the `ShinyChanges` folder, insert that image to the proper place using ["Pokemon Ds/Pic Platinum"](https://projectpokemon.org/home/files/file/2085-pokedspic/). (Note that some Pokémon might have changes to the base sprite.)
14. Reinsert `hg_pokegra.narc` back into `root/a/0/0/4`.
15. If you want to be INSANELY thorough, extract `root/pbr/pokegra.narc` and replace each changed palette entry, and reinsert. (I think this has to do with Pokémon Battle Revolution - I doubt you really have to do this.)
16. Extract `root/a/0/8/1` as `ow_sprites.narc`.
17. Run `./pack_follow_pal.sh`.
18. Insert the resulting `ow_sprites_patched.narc` to `root/a/0/8/1`.


## How It Works

As stated, each Pokémon has its palette hue shifted by an amount determined by their personality value. To be more precise, the hue shift is currently coded to be within +/- 20 degrees, and the third personality byte, masked with `0x3F`, is used to determine it, meaning there are 64 possible steps within that range. (Though, it should be noted values `0x00` and `0x20` both mean "no shift", and realistically, the steps are granular enough to the point where two adjacent values may end up producing the same color. So, it's effectively less than 64.)

The added code used to make this work are inserted in a "synthetic overlay". An unused file in the game is hacked to load at startup, which we can replace with any code we want. Check out [this guide](https://pokehacking.com/tutorials/ramexpansion/) by Mikelan98 and Nomura for more details. I also use this space as free RAM when needed, also. A quick layout:

| Address      | Description                                                                                                                                                                                                    |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `0x023C81A4` | Personality value of player Pokémon 1                                                                                                                                                                          |
| `0x023C81A8` | Personality value of enemy Pokémon 1                                                                                                                                                                           |
| `0x023C81AC` | Personality value of player/partner Pokémon 2                                                                                                                                                                  |
| `0x023C81B0` | Personality value of enemy Pokémon 2                                                                                                                                                                           |
| `0x023C81B4` | Saved-off variable battle data pointer                                                                                                                                                                         |
| `0x023C81B8` | Unused                                                                                                                                                                                                         |
| `0x023C81BC` | `0xBA771E` if currently in battle,  something else otherwise. Set by `Hijack_BattleStart`, `Hijack_BattleEnd`, `Hijack_BattleEndCaught`. Read by `Hijack_HueShift.s`                                          |
| `0x023C81C0` | Read in `Hijack_GbaPal.s` to determine if up the call chain, it was signalled that a Pokémon's battle sprite palette is being loaded. `0xBEEFXXXX` where `XXXX` is the index of the sprite being loaded (0-3). Also set to `0xB0C5` by `Hijack_BoxSprite1.s` to be read by `Hijack_BoxSprite2.s` when loading a palette in the PC box. |
| `0x023C81C4` | Contains the personality value of the Pokémon read by the last call to `GetPkmnData` or `GetBoxPkmnData`, read by `Hijack_HueShift.s` and `Hijack_MiscSprite.s`.                                             |

A rundown of the code files involved:

* `hueshift.c` - Contains the function that performs a hue shift on a given palette by a value (limited through a mask with `0x3F`). The method for hue shifting was taken from [this StackOverflow post](https://stackoverflow.com/a/8510751/963007) but adapted to do it in fixed point since the DS does not have a floating point unit. Instead of trying to run sin/cos functions directly, I generate two tables (see `tableprinter.d`) of precomputed sin/cos values in the fixed point format I wanted. Values `0x00` through `0x1F` shift positively, while `0x20` through `0x3F` shift negatively.

* `Hijack_PersonalitySave.s` - This code is jumped to from hijacks in both GetPkmnData and GetBoxPkmnData. It just grabs the personality value of the Pokémon involved in this function call (stored conveniently as the first thing in the data block pointed to by `r0`) and puts it at `0x023C81C4` to be used by `Hijack_HueShift.s`.

* `Hijack_HueShift.s` - Hijacks right during a palette load for most instances of a Pokémon's sprite. *Most* of the time, Pokémon sprites are drawn as a textured polygon for the squash/stretch effect for when they're animated. Outside of battle, the personality value used is stored at `0x023C81C4`. The hope here is that whatever the last call to `GetPkmnData` or `GetBoxPkmnData` prior to this code being reached was for the Pokémon we're loading the palette for. However, this is not necessarily true during a battle, and in that case, it will read from the personality table at `0x023C81A4` (see `Hijack_PersonalityTableBuild2.s`). The code in `hueshift.c` is then called to achieve the hue shift effect.

* `Hijack_BattleDataPtrSave.s` - This hijacks a function in overlay 12 ("Battle Interface") called `GetMainBattleData_GetAdrOfPkmnInParty`. It stores a pointer stored passed in `r0` relating to varialbe battle data to `0x023C81B4` so that it can be used in `Hijack_PersonalityTableBuild.s`. (Note: This very probably could have been achieved by hijacking a different place instead, but this still works.)

* `Hijack_BattleStart` - Hijacks the `0` case of the switch in `BattleEngineInit` in overlay 12 (right when a battle starts). Stores `0xBA771E` into `0x023C81BC` to be read later by `Hijack_HueShift.s`.

* `Hijack_BattleEnd` - Hijacks the `9` case of the switch in `BattleEngineInit` in overlay 12 (right when a battle ends). Stores `0` into `0x023C81BC` to be read later by `Hijack_HueShift.s`.

* `Hijack_BattleEndCaught` - Hijacks in `TryToCatchPkmn` in overlay 12 when a Pokémon is caught. Stores `0` into `0x023C81BC` to be read later by `Hijack_HueShift.s`. This prevents the sprites loaded during the post-capture sequence from using the in-battle personality table, since they always use the 0th sprite slot.

* `Hijack_PersonalityTableBuild.s` - Hijacks inside a function in overlay 7 ("Move Animations") that gets called whenever a Pokémon is being switched out. In battles, not only do Pokémon load the typical textured polygon sprite, but during various battle animations, a GBA-styled tile-based sprite that looks just like the other one is placed on top of it. To account for this, I had to do a lot more work to figure out which Pokémon's sprite is being loaded. My code is ran in the middle of a loop from 0 to 3 (one for each Pokémon that could be on the field). I have to use this current index to read into a table describing which Pokémon are actually on the field at the moment (can be 0-5), call `GetMainBattleData_GetAdrOfPkmnInParty` to grab the pointer to that Pokémon in whatever party it's in, get the personality value, then store it off in my table at `0x023C81A4` so it can be read later. (Note: The meaning of the loop indices 0-3 is the same as in the free RAM table above).

* `Hijack_PersonalityTableBuild2.s` - Hijacks inside `AllocInitMainBattleData` in overlay 12; when a battle begins, right after all the data is loaded. Basically the same as `Hijack_PersonalityTableBuild.s`, but it does a loop over active Pokémon indices 0-3 itself.

* `Hijack_BattleSprite.s` - Hijacked in the same function `Hijack_PersonalityTableBuild.s`, reached soon after it if the current loop index is for a Pokémon who needs to load its alternate sprite during the switchout animation. Stores `0xBEEFXXXX` where `XXXX` is the current loop index at `0x023C81C0` so it can be read by `Hijack_GbaPal.s`.

* `Hijack_BattleSprite2.s` - Reached during move animations. Does basically the same thing as `Hijack_BattleSprite.s`.

* `Hijack_GbaPal.s` - Reached from down the call chain after `Hijack_BattleSprite.s` or `Hijack_BattleSprite2.s`. Reads `0x023C81C0`, looking for `0xBEEF` to determine whether this is a Pokémon's palette being loaded. If so, it uses the current battle sprite ID to index into the personality value table at `0x023C81A4` and then use it to call the code in `hueshift.c`. `0x023C81C0` is then set to `0` so to ensure that this code won't run again unless this is for a Pokémon sprite.

* `Hijack_MiscSprite.s` - Hijacks inside a function used for loading the palette for Pokémon sprites in miscellaneous circumstances, like during the HM use animation and in the introduction when Professor Rowan sends out a Pokémon. Loads the personality value at `0x023C81C4` and calls the code at `hueshift.c`.

* `Hijack_BoxSprite1.s` - Hijacks inside a function in overlay 14, right before a Pokémon's palette is loaded while in the PC box. Sets `0x023C81C0` to `0xB0C5` to be read by `Hijack_BoxSprite2.s` down the call chain.

* `Hijack_BoxSprite2.s` - Hijacks inside a function used generically to load a palette form a narc file and upload it to palette RAM. If `0x023C81C0` was set to `0xB0C5`, a hue shift on the palette is performed using the personality value at `0x023C81C4`.


## Credits

* [MKHT](https://twitter.com/mkht_real) - Lots of help choosing shiny colors.
* [Mikelan98, Nomura](https://pokehacking.com/r/20041000) - ARM9 Expansion Subroutine